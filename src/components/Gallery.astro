---
interface Props {
  lang: 'es' | 'en' | 'zh';
  t: (key: string) => string;
}

const { t } = Astro.props;

const images = [
  { src: '/gallery/Web45.webp', alt: 'Crystal clear river with Aconcagua in the background — the start of the approach' },
  { src: '/gallery/Web9.webp',  alt: 'Aconcagua from the Horcones valley — classic full mountain view' },
  { src: '/gallery/Web39.webp', alt: 'Expedition team selfie at the start of the trek with Aconcagua behind' },
  { src: '/gallery/Web10.webp', alt: 'Expedition group hiking through the lower Aconcagua valley' },
  { src: '/gallery/Web7.webp',  alt: 'Team of six climbers ascending in a line on the high slopes' },
  { src: '/gallery/Web38.webp', alt: 'Guided expedition team on rocky high-altitude terrain' },
  { src: '/gallery/Web34.webp', alt: 'Climbers ascending a steep snow slope with the vast Andes behind' },
  { src: '/gallery/Web35.webp', alt: 'Mountaineer in full high-altitude expedition gear on Aconcagua' },
  { src: '/gallery/Web31.webp', alt: 'Two climbers pushing through a blizzard on the upper mountain' },
  { src: '/gallery/Web2.webp',  alt: 'Orange expedition tents at golden hour with Aconcagua glowing behind' },
  { src: '/gallery/Web4.webp',  alt: 'Base camp geodesic domes with a lenticular cloud capping the summit' },
  { src: '/gallery/Web13.webp', alt: 'Glowing tent at dusk with mountain silhouettes — base camp night scene' },
  { src: '/gallery/Web42.webp', alt: 'Aconcagua illuminated by alpenglow at night with expedition tents below' },
  { src: '/gallery/Web28.webp', alt: 'Three expedition members enjoying a meal at high camp' },
  { src: '/gallery/Web17.webp', alt: 'Julián Kusi with a client at the Aconcagua summit holding the summit sign' },
  { src: '/gallery/Web5.webp',  alt: 'Dramatic fiery red sunrise over the Andes from high altitude' },
  { src: '/gallery/Web27.webp', alt: 'Climbers ascending toward the summit at dawn with the mountain shadow stretching below' },
  { src: '/gallery/Web12.webp', alt: 'Aerial view looking down at the colorful high camp tents on Aconcagua' },
  { src: '/gallery/Web20.webp', alt: 'Panoramic summit view of the Andes from 6,962 m' },
  { src: '/gallery/Web19.webp', alt: 'Julián Kusi summit celebration with the full expedition group' },
];
---

<section id="galeria" class="gallery">
  <div class="gallery-header reveal">
    <p class="tag">{t('gallery.tag')}</p>
    <h2>{t('gallery.title')}</h2>
    <p class="gallery-subtitle">{t('gallery.subtitle')}</p>
  </div>

  <div class="strip-wrap">
    <!-- Left fade + arrow -->
    <button id="gallery-prev" class="strip-arrow strip-arrow--left" aria-label={t('gallery.prev')} type="button">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>

    <div class="strip-fade strip-fade--left" aria-hidden="true"></div>

    <div id="gallery-strip" class="strip" role="list">
      {images.map((img, i) => (
        <button
          class="strip-item"
          data-index={i}
          aria-label={img.alt}
          type="button"
          role="listitem"
        >
          <img
            src={img.src}
            alt={img.alt}
            loading={i < 5 ? 'eager' : 'lazy'}
            decoding="async"
          />
        </button>
      ))}
    </div>

    <div class="strip-fade strip-fade--right" aria-hidden="true"></div>

    <!-- Right arrow -->
    <button id="gallery-next" class="strip-arrow strip-arrow--right" aria-label={t('gallery.next')} type="button">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </button>
  </div>
</section>

<!-- Lightbox -->
<div
  id="gallery-lightbox"
  role="dialog"
  aria-modal="true"
  aria-label={t('gallery.lightbox_label')}
  hidden
>
  <button id="lb-close" aria-label={t('gallery.close')} type="button">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </button>

  <button id="lb-prev" aria-label={t('gallery.prev')} type="button">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
  </button>

  <div id="lb-img-wrap">
    <img id="lb-img" src="" alt="" />
  </div>

  <button id="lb-next" aria-label={t('gallery.next')} type="button">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </button>

  <p id="lb-counter" aria-live="polite"></p>
</div>

<style>
  /* ── Section ──────────────────────────────────────── */
  .gallery {
    background: var(--bg-section-alt);
    padding-block: clamp(48px, 6vw, 80px);
    overflow: hidden;
  }

  .gallery-header {
    text-align: center;
    max-width: 560px;
    margin-inline: auto;
    padding-inline: 24px;
    margin-bottom: clamp(28px, 4vw, 40px);
  }

  .gallery-header h2 {
    font-size: var(--fs-h1);
    color: var(--text-primary);
    margin-top: 4px;
    margin-bottom: 10px;
  }

  .gallery-subtitle {
    color: var(--text-secondary);
    font-size: var(--fs-body);
    line-height: 1.6;
    margin: 0;
  }

  /* ── Strip wrapper ────────────────────────────────── */
  .strip-wrap {
    position: relative;
  }

  /* ── Filmstrip ────────────────────────────────────── */
  .strip {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-behavior: smooth;
    scroll-snap-type: x mandatory;
    padding-inline: max(24px, calc((100vw - 1200px) / 2));
    padding-block: 4px; /* allow box-shadow on hover */
    /* hide scrollbar */
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  .strip::-webkit-scrollbar { display: none; }

  /* ── Strip item ───────────────────────────────────── */
  .strip-item {
    flex: 0 0 auto;
    width: 200px;
    height: 280px;
    border-radius: var(--radius-md);
    overflow: hidden;
    cursor: pointer;
    padding: 0;
    border: none;
    background: var(--bg-card);
    scroll-snap-align: start;
    transition: transform 0.25s ease, box-shadow 0.25s ease;
    position: relative;
  }

  .strip-item:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-hover);
  }

  .strip-item:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  .strip-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform 0.4s ease;
    pointer-events: none;
  }

  .strip-item:hover img {
    transform: scale(1.04);
  }

  /* ── Fade edges ───────────────────────────────────── */
  .strip-fade {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 80px;
    z-index: 2;
    pointer-events: none;
  }

  .strip-fade--left {
    left: 0;
    background: linear-gradient(to right, var(--bg-section-alt), transparent);
  }

  .strip-fade--right {
    right: 0;
    background: linear-gradient(to left, var(--bg-section-alt), transparent);
  }

  /* ── Arrow buttons ────────────────────────────────── */
  .strip-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 3;
    background: var(--bg-card);
    border: 1px solid var(--border-card);
    color: var(--text-primary);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 0;
    transition: background 0.2s, box-shadow 0.2s, opacity 0.2s;
    box-shadow: var(--shadow-card);
    opacity: 0.85;
  }

  .strip-arrow:hover {
    background: var(--accent);
    color: white;
    opacity: 1;
    box-shadow: var(--shadow-gold);
    border-color: transparent;
  }

  .strip-arrow--left { left: 16px; }
  .strip-arrow--right { right: 16px; }

  .strip-arrow.hidden { opacity: 0; pointer-events: none; }

  /* ── Lightbox ─────────────────────────────────────── */
  #gallery-lightbox {
    position: fixed;
    inset: 0;
    z-index: 9000;
    background: rgba(0, 0, 0, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
  }

  #gallery-lightbox[hidden] { display: none; }

  #lb-img-wrap {
    max-width: min(90vw, 860px);
    max-height: 85vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #lb-img {
    max-width: 100%;
    max-height: 85vh;
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: var(--radius-md);
    display: block;
    transition: opacity 0.2s ease;
  }

  #lb-img.lb-loading { opacity: 0.25; }

  #lb-close,
  #lb-prev,
  #lb-next {
    position: fixed;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.12);
    color: white;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 0;
    transition: background 0.2s;
    flex-shrink: 0;
  }

  #lb-close:hover,
  #lb-prev:hover,
  #lb-next:hover { background: rgba(255, 255, 255, 0.18); }

  #lb-close { top: 20px; right: 20px; }
  #lb-prev  { left: 16px; top: 50%; transform: translateY(-50%); }
  #lb-next  { right: 16px; top: 50%; transform: translateY(-50%); }

  #lb-counter {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    color: rgba(255, 255, 255, 0.45);
    font-size: var(--fs-xs);
    letter-spacing: 0.06em;
    margin: 0;
  }

  /* ── Responsive ───────────────────────────────────── */
  @media (max-width: 768px) {
    .strip-item {
      width: 160px;
      height: 224px;
    }

    .strip-arrow { display: none; }
    .strip-fade { width: 40px; }
  }

  @media (max-width: 480px) {
    .strip-item {
      width: 140px;
      height: 196px;
    }

    #lb-prev { left: 8px; }
    #lb-next { right: 8px; }
    #lb-prev, #lb-next { width: 40px; height: 40px; }
  }
</style>

<script>
  const images = [
    { src: '/gallery/Web45.webp', alt: 'Crystal clear river with Aconcagua in the background' },
    { src: '/gallery/Web9.webp',  alt: 'Aconcagua from the Horcones valley' },
    { src: '/gallery/Web39.webp', alt: 'Expedition team selfie at the start of the trek' },
    { src: '/gallery/Web10.webp', alt: 'Expedition group hiking through the Aconcagua valley' },
    { src: '/gallery/Web7.webp',  alt: 'Team of six climbers ascending in a line' },
    { src: '/gallery/Web38.webp', alt: 'Expedition team on rocky high-altitude terrain' },
    { src: '/gallery/Web34.webp', alt: 'Climbers ascending a steep snow slope' },
    { src: '/gallery/Web35.webp', alt: 'Mountaineer in full high-altitude expedition gear' },
    { src: '/gallery/Web31.webp', alt: 'Two climbers pushing through a blizzard' },
    { src: '/gallery/Web2.webp',  alt: 'Expedition tents at golden hour' },
    { src: '/gallery/Web4.webp',  alt: 'Base camp with lenticular cloud over the summit' },
    { src: '/gallery/Web13.webp', alt: 'Glowing tent at dusk — base camp night scene' },
    { src: '/gallery/Web42.webp', alt: 'Aconcagua alpenglow at night' },
    { src: '/gallery/Web28.webp', alt: 'Expedition members at a meal in high camp' },
    { src: '/gallery/Web17.webp', alt: 'Julián Kusi with a client at the Aconcagua summit' },
    { src: '/gallery/Web5.webp',  alt: 'Fiery red sunrise over the Andes from high altitude' },
    { src: '/gallery/Web27.webp', alt: 'Climbers ascending toward the summit at dawn' },
    { src: '/gallery/Web12.webp', alt: 'Aerial view of high camp tents on Aconcagua' },
    { src: '/gallery/Web20.webp', alt: 'Panoramic summit view of the Andes from 6,962 m' },
    { src: '/gallery/Web19.webp', alt: 'Julián Kusi summit celebration with the expedition group' },
  ];

  // ── Strip scroll arrows ──────────────────────────────
  const strip    = document.getElementById('gallery-strip') as HTMLElement;
  const btnPrev  = document.getElementById('gallery-prev') as HTMLButtonElement;
  const btnNext  = document.getElementById('gallery-next') as HTMLButtonElement;

  const SCROLL_BY = 440;

  function updateArrows() {
    btnPrev.classList.toggle('hidden', strip.scrollLeft <= 4);
    btnNext.classList.toggle('hidden', strip.scrollLeft + strip.clientWidth >= strip.scrollWidth - 4);
  }

  btnPrev.addEventListener('click', () => strip.scrollBy({ left: -SCROLL_BY, behavior: 'smooth' }));
  btnNext.addEventListener('click', () => strip.scrollBy({ left:  SCROLL_BY, behavior: 'smooth' }));
  strip.addEventListener('scroll', updateArrows, { passive: true });
  updateArrows();

  // ── Lightbox ─────────────────────────────────────────
  const lightbox  = document.getElementById('gallery-lightbox') as HTMLElement;
  const lbImg     = document.getElementById('lb-img') as HTMLImageElement;
  const lbClose   = document.getElementById('lb-close') as HTMLButtonElement;
  const lbPrev    = document.getElementById('lb-prev') as HTMLButtonElement;
  const lbNext    = document.getElementById('lb-next') as HTMLButtonElement;
  const lbCounter = document.getElementById('lb-counter') as HTMLParagraphElement;

  let current = 0;
  let lastFocused: HTMLElement | null = null;

  function showImage(index: number) {
    current = (index + images.length) % images.length;
    const img = images[current];
    lbImg.classList.add('lb-loading');
    const tmp = new Image();
    tmp.onload = () => {
      lbImg.src = img.src;
      lbImg.alt = img.alt;
      lbImg.classList.remove('lb-loading');
    };
    tmp.src = img.src;
    lbCounter.textContent = `${current + 1} / ${images.length}`;
  }

  function openLightbox(index: number) {
    lastFocused = document.activeElement as HTMLElement;
    lightbox.hidden = false;
    document.body.style.overflow = 'hidden';
    showImage(index);
    lbClose.focus();
  }

  function closeLightbox() {
    lightbox.hidden = true;
    document.body.style.overflow = '';
    lastFocused?.focus();
  }

  document.querySelectorAll<HTMLButtonElement>('.strip-item').forEach((btn) => {
    btn.addEventListener('click', () => openLightbox(parseInt(btn.dataset.index ?? '0', 10)));
  });

  lbClose.addEventListener('click', closeLightbox);
  lbPrev.addEventListener('click', () => showImage(current - 1));
  lbNext.addEventListener('click', () => showImage(current + 1));
  lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });

  document.addEventListener('keydown', (e) => {
    if (lightbox.hidden) return;
    if (e.key === 'Escape')      closeLightbox();
    if (e.key === 'ArrowLeft')   showImage(current - 1);
    if (e.key === 'ArrowRight')  showImage(current + 1);
  });

  // Touch swipe on lightbox
  let touchStartX = 0;
  lightbox.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; }, { passive: true });
  lightbox.addEventListener('touchend',   (e) => {
    const dx = e.changedTouches[0].clientX - touchStartX;
    if (Math.abs(dx) > 50) dx < 0 ? showImage(current + 1) : showImage(current - 1);
  }, { passive: true });
</script>
