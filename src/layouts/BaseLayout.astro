---
import '../styles/global.css';
import '../styles/animations.css';

interface Props {
  title: string;
  description: string;
  lang: 'es' | 'en' | 'zh';
  ogLocale?: string;
  ogUrl?: string;
  ogImage?: string;
}

const {
  title,
  description,
  lang,
  ogLocale = 'es_AR',
  ogUrl = 'https://aconcagua.co/',
ogImage = 'https://aconcagua.co/openegraph.jpeg',
} = Astro.props;

const alternates = [
  { lang: 'es-AR', href: 'https://aconcagua.co/' },
  { lang: 'en-US', href: 'https://aconcagua.co/en/' },
  { lang: 'zh-CN', href: 'https://aconcagua.co/zh/' },
  { lang: 'x-default', href: 'https://aconcagua.co/' },
];

const jsonLd = [
  {
    '@context': 'https://schema.org',
    '@type': ['TouristInformationCenter', 'LocalBusiness'],
    '@id': 'https://aconcagua.co/#business',
    name: 'Julián Kusi — Aconcagua Mountain Guide',
    description: 'Certified Aconcagua mountain guide with 17 successful summits and 10+ years of experience guiding international expeditions.',
    url: 'https://aconcagua.co',
    telephone: '+57 314 629 4318',
    email: 'julian@aconcagua.co',
    image: 'https://aconcagua.co/portrait.jpeg',
    logo: 'https://aconcagua.co/logo.webp',
    knowsAbout: ['Aconcagua', 'mountain guiding', 'high altitude trekking', 'expedition safety', 'Patagonia climbing'],
    address: {
      '@type': 'PostalAddress',
      addressLocality: 'Mendoza',
      addressCountry: 'AR',
    },
    geo: {
      '@type': 'GeoCoordinates',
      latitude: -32.8895,
      longitude: -68.8458,
    },
    areaServed: {
      '@type': 'Place',
      name: 'Aconcagua Provincial Park, Argentina',
    },
    priceRange: '$$$',
    aggregateRating: {
      '@type': 'AggregateRating',
      ratingValue: '5',
      reviewCount: '3',
      bestRating: '5',
      worstRating: '1',
    },
    review: [
      {
        '@type': 'Review',
        author: { '@type': 'Person', name: 'Marco Rossi' },
        reviewRating: { '@type': 'Rating', ratingValue: '5', bestRating: '5' },
        reviewBody: 'Julián is an exceptional guide. His knowledge of the mountain, his calm in difficult situations, and his genuine concern for the group\'s safety made this expedition an unforgettable experience. We reached the summit because of him.',
      },
      {
        '@type': 'Review',
        author: { '@type': 'Person', name: 'Sarah Kim' },
        reviewRating: { '@type': 'Rating', ratingValue: '5', bestRating: '5' },
        reviewBody: 'I couldn\'t have chosen a better guide for my first Aconcagua expedition. Julián anticipated every challenge, kept us motivated during the hardest moments, and celebrated with us at the top. A transformative experience.',
      },
      {
        '@type': 'Review',
        author: { '@type': 'Person', name: 'James Walsh' },
        reviewRating: { '@type': 'Rating', ratingValue: '5', bestRating: '5' },
        reviewBody: 'World-class professionalism. Julián coordinated every logistical detail with precision, his English is excellent, and his leadership in extreme conditions is impressive. I\'m already planning to come back with him next year.',
      },
    ],
    sameAs: [
      'https://www.instagram.com/julian_kusi',
      'https://www.youtube.com/@juliankusi',
      'https://www.tiktok.com/@julian_kusi',
    ],
    hasOfferCatalog: {
      '@type': 'OfferCatalog',
      name: 'Aconcagua Expedition Packages',
      itemListElement: [
        {
          '@type': 'Offer',
          name: 'Basic Expedition Package',
          description: 'Park access permits and mandatory insurance. Client manages own logistics.',
          price: '2500',
          priceCurrency: 'USD',
          priceSpecification: { '@type': 'PriceSpecification', minPrice: '2500', priceCurrency: 'USD' },
        },
        {
          '@type': 'Offer',
          name: 'Base Camp Expedition Package',
          description: 'Mule transport, base camp accommodations, full meals, internet, and facilities at base camp.',
          price: '4000',
          priceCurrency: 'USD',
          priceSpecification: { '@type': 'PriceSpecification', minPrice: '4000', priceCurrency: 'USD' },
        },
        {
          '@type': 'Offer',
          name: 'Full Expedition Package',
          description: 'Complete guided expedition. Hotel in Mendoza, transfers, mules, full meals, accommodations, 1 guide per 4 climbers. Option to join Julián Kusi directly.',
          price: '7000',
          priceCurrency: 'USD',
          priceSpecification: { '@type': 'PriceSpecification', minPrice: '7000', priceCurrency: 'USD' },
        },
        {
          '@type': 'Offer',
          name: '1:1 Private Expedition Package',
          description: 'Fully customizable private expedition with a dedicated 1-on-1 certified mountain guide.',
          price: '15000',
          priceCurrency: 'USD',
          priceSpecification: { '@type': 'PriceSpecification', minPrice: '15000', priceCurrency: 'USD' },
        },
      ],
    },
  },
  {
    '@context': 'https://schema.org',
    '@type': 'Person',
    '@id': 'https://aconcagua.co/#julian-kusi',
    name: 'Julián Kusi',
    jobTitle: 'Certified Mountain Guide',
    description: 'EPGAMT-certified Aconcagua mountain guide with 17 successful summits and 10+ years of experience guiding international expeditions in Spanish, English, and Chinese.',
    image: 'https://aconcagua.co/portrait.jpeg',
    url: 'https://aconcagua.co',
    email: 'julian@aconcagua.co',
    knowsLanguage: ['es', 'en', 'zh'],
    knowsAbout: ['Aconcagua', 'mountain guiding', 'high altitude trekking', 'expedition safety', 'wilderness first response'],
    hasCredential: [
      { '@type': 'EducationalOccupationalCredential', name: 'EPGAMT', description: 'Escuela de Porteadores y Guías de Alta Montaña — official Argentine mountain guide certification' },
      { '@type': 'EducationalOccupationalCredential', name: 'WFR', description: 'Wilderness First Responder — advanced wilderness emergency medical training' },
    ],
    worksFor: { '@id': 'https://aconcagua.co/#business' },
    sameAs: [
      'https://www.instagram.com/julian_kusi',
      'https://www.youtube.com/@juliankusi',
      'https://www.tiktok.com/@julian_kusi',
    ],
  },
];
---

<!doctype html>
<html lang={lang} class:list={[{ 'lang-zh': lang === 'zh' }]}>
  <head>
    <meta charset="UTF-8" />
    <!-- FOWT prevention: set data-theme before CSS renders -->
    <script is:inline>
      (function() {
        var stored = localStorage.getItem('theme');
        var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        var theme = stored || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />

    <!-- Canonical & hreflang -->
    <link rel="canonical" href={ogUrl} />
    {alternates.map(alt => (
      <link rel="alternate" hreflang={alt.lang} href={alt.href} />
    ))}

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={ogUrl} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:locale" content={ogLocale} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <!-- Preload hero image (LCP element) -->
    <link rel="preload" as="image" href="/hero.webp" fetchpriority="high" />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg?v=1" />
    <link rel="alternate icon" href="/favicon.svg?v=1" />

    <!-- Fonts: preconnect for Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Calendly CSS - deferred loading trick -->
    <link
      rel="stylesheet"
      href="https://assets.calendly.com/assets/external/widget.css"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
      <link rel="stylesheet" href="https://assets.calendly.com/assets/external/widget.css" />
    </noscript>

    <title>{title}</title>

    <!-- Analytics load only after cookie consent (see body) -->

    <!-- JSON-LD Structured Data -->
    {jsonLd.map(schema => (
      <script type="application/ld+json" set:html={JSON.stringify(schema)} />
    ))}
  </head>
  <body>
    <!-- Skip link -->
    <a href="#main-content" class="skip-link">
      {lang === 'es' ? 'Saltar al contenido principal' : lang === 'zh' ? '跳至主要内容' : 'Skip to main content'}
    </a>

    <slot />

    <!-- Cookie consent banner -->
    <div id="cookie-banner" role="dialog" aria-live="polite" aria-label={
      lang === 'zh' ? 'Cookie 设置' : lang === 'en' ? 'Cookie settings' : 'Configuración de cookies'
    } hidden>
      <p id="cookie-text"></p>
      <div class="cookie-actions">
        <button id="cookie-accept" class="cookie-btn cookie-btn-accept"></button>
        <button id="cookie-decline" class="cookie-btn cookie-btn-decline"></button>
      </div>
    </div>

    <style>
      #cookie-banner {
        position: fixed;
        bottom: 24px;
        left: 24px;
        max-width: 420px;
        background: #0f1923;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 12px;
        padding: 20px 24px;
        z-index: 9999;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      #cookie-banner[hidden] { display: none; }
      #cookie-text {
        font-size: 0.8125rem;
        line-height: 1.6;
        color: rgba(255,255,255,0.7);
        margin: 0;
      }
      #cookie-text a {
        color: #C88A3E;
        text-decoration: underline;
      }
      .cookie-actions {
        display: flex;
        gap: 10px;
      }
      .cookie-btn {
        flex: 1;
        padding: 9px 16px;
        border-radius: 8px;
        font-size: 0.8125rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: opacity 0.15s;
      }
      .cookie-btn:hover { opacity: 0.85; }
      .cookie-btn-accept {
        background: #C88A3E;
        color: #fff;
      }
      .cookie-btn-decline {
        background: rgba(255,255,255,0.08);
        color: rgba(255,255,255,0.65);
      }
      @media (max-width: 480px) {
        #cookie-banner {
          left: 12px;
          right: 12px;
          bottom: 12px;
          max-width: none;
        }
      }
    </style>

    <script is:inline define:vars={{ lang }}>
      (function () {
        var CONSENT_KEY = 'cookie_consent';

        function loadAnalytics() {
          // GA4
          var s = document.createElement('script');
          s.async = true;
          s.src = 'https://www.googletagmanager.com/gtag/js?id=G-6ZXZ206Z8T';
          document.head.appendChild(s);
          window.dataLayer = window.dataLayer || [];
          function gtag() { dataLayer.push(arguments); }
          window.gtag = gtag;
          gtag('js', new Date());
          gtag('config', 'G-6ZXZ206Z8T');

          // Microsoft Clarity
          (function (c, l, a, r, i, t, y) {
            c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments); };
            t = l.createElement(r); t.async = 1; t.src = 'https://www.clarity.ms/tag/' + i;
            y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
          })(window, document, 'clarity', 'script', 'vmzrpyylnq');
        }

        var texts = {
          es: {
            msg: 'Usamos cookies de análisis (Google Analytics y Microsoft Clarity) para mejorar tu experiencia. <a href="/privacidad">Política de Privacidad</a>.',
            accept: 'Aceptar',
            decline: 'Rechazar',
          },
          en: {
            msg: 'We use analytics cookies (Google Analytics & Microsoft Clarity) to improve your experience. <a href="/en/privacy">Privacy Policy</a>.',
            accept: 'Accept',
            decline: 'Decline',
          },
          zh: {
            msg: '我们使用分析Cookie（Google Analytics和Microsoft Clarity）来改善您的体验。<a href="/zh/privacy">隐私政策</a>。',
            accept: '接受',
            decline: '拒绝',
          },
        };

        var banner = document.getElementById('cookie-banner');
        var textEl = document.getElementById('cookie-text');
        var acceptBtn = document.getElementById('cookie-accept');
        var declineBtn = document.getElementById('cookie-decline');
        var t = texts[lang] || texts.en;

        function showBanner() {
          textEl.innerHTML = t.msg;
          acceptBtn.textContent = t.accept;
          declineBtn.textContent = t.decline;
          banner.hidden = false;
        }

        acceptBtn.addEventListener('click', function () {
          localStorage.setItem(CONSENT_KEY, 'granted');
          banner.hidden = true;
          loadAnalytics();
        });

        declineBtn.addEventListener('click', function () {
          localStorage.setItem(CONSENT_KEY, 'denied');
          banner.hidden = true;
        });

        // "Manage Cookies" buttons in footer — reset preference and re-show banner
        document.querySelectorAll('#manage-cookies, #manage-cookies-bottom').forEach(function (btn) {
          btn.addEventListener('click', function () {
            localStorage.removeItem(CONSENT_KEY);
            showBanner();
          });
        });

        // Initial state
        var stored = localStorage.getItem(CONSENT_KEY);
        if (stored === 'granted') {
          loadAnalytics();
        } else if (!stored) {
          showBanner();
        }
      })();
    </script>

    <!-- Floating WhatsApp button (mobile only, appears after 30% scroll) -->
    <a
      id="wa-float"
      href="https://wa.me/573146294318"
      target="_blank"
      rel="noopener noreferrer"
      aria-label={lang === 'es' ? 'Contactar por WhatsApp' : lang === 'zh' ? '通过WhatsApp联系' : 'Contact via WhatsApp'}
    >
      <svg width="26" height="26" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
      </svg>
    </a>

    <style>
      #wa-float {
        display: none;
        position: fixed;
        bottom: 24px;
        right: 20px;
        z-index: 900;
        width: 52px;
        height: 52px;
        border-radius: 50%;
        background: #25D366;
        color: #fff;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 16px rgba(37, 211, 102, 0.45);
        transition: opacity 0.3s, transform 0.3s;
        opacity: 0;
        pointer-events: none;
      }
      #wa-float.wa-visible {
        opacity: 1;
        pointer-events: auto;
      }
      #wa-float:hover {
        background: #1ebe59;
        transform: scale(1.07);
      }
      @media (max-width: 768px) {
        #wa-float {
          display: flex;
        }
      }
    </style>

    <script>
      (function() {
        var btn = document.getElementById('wa-float');
        if (!btn) return;
        var shown = false;
        window.addEventListener('scroll', function() {
          var scrolled = window.scrollY / (document.body.scrollHeight - window.innerHeight);
          if (!shown && scrolled >= 0.30) {
            btn.classList.add('wa-visible');
            shown = true;
          }
        }, { passive: true });
      })();
    </script>

    <!-- Calendly JS - async defer -->
    <script
      async
      defer
      src="https://assets.calendly.com/assets/external/widget.js"
      type="text/javascript"
    ></script>

    <!-- Analytics: GA4 + Clarity + Event Tracking -->
    <script src="../scripts/analytics.ts"></script>

    <!-- Scroll reveal observer -->
    <script>
      (function() {
        const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        if (prefersReduced) {
          // Show all reveal elements immediately
          document.querySelectorAll('.reveal, .reveal-left, .reveal-right').forEach(el => {
            el.classList.add('visible');
          });
          return;
        }

        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('visible');
              observer.unobserve(entry.target);
            }
          });
        }, {
          threshold: 0.1,
          rootMargin: '0px 0px -40px 0px',
        });

        document.querySelectorAll('.reveal, .reveal-left, .reveal-right').forEach(el => {
          observer.observe(el);
        });
      })();
    </script>
  </body>
</html>
